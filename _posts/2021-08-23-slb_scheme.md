# SLB方案
/* @updated 2021-08-23 */

## 背景
我们在2021年初对XXX系统进行了一次架构升级演进：把原本MySQL主从模式1主N从，读写分离的数据库架构替换成了分布式数据库TiDB。
当解决了数据库的存储的性能瓶颈，新的瓶颈出现在了web容器的单体性能上。随着用户数的增长，并发压力主要落在应用服务的单体上，响应逐渐变慢。


## 目标
- 优化原有架构
- 用户状态、缓存等保存到专用的缓存服务器；附件保存到云存储中
- 集群部署和负载均衡
- 为日益增长的用户数，以及节假日前突发流量做准备


## 实现方案
系统目前还属于普通的Web开发，即常用的单应用模式。这种方式对于一般的Web应用，维护相对简单且使用很方便，完全能够胜任。但是对于高并发的企业级网站，就显得力不从心。单台服务器就算将性能优化得再好，也不能支撑大用户量的访问压力了，这个时候就需要设计高性能的集群来应对。

本次架构演进的方向正是引入负载均衡实现集群部署，实现方式如下：

使用Web集群方式部署之后，首要调整的就是用户状态信息与附件信息。用户状态不能再保存到Session中，缓存也不能用本地Web服务器的文件缓存。以及附件也不能保存在Web应用服务器上了。因为要保证集群里面的各个Web服务器，状态完全一致。因此，需要将用户状态、缓存等保存到专用的缓存服务器，比如Memcache。附件需要保存到云存储中，比如七牛云存储、阿里云存储、腾讯云存储等。

### 1、缓存服务器
集中设置一个缓存服务器，然后对应用进行一些代码层面的改造，将Session、缓存等保存到缓存服务器上。

- 自己搭建。找一台ecs实例分别安装memcache、redis数据库。所有的应用都连到这个缓存服务器上（业务量上来，下下一步考虑如何升级为分布式缓存服务）。
- 使用云数据库。云数据库Memcache版、云数据库Redis版。

### 2、云存储
同样，原本应用上传下载等附件的操作方式也需要进行修改，改为保存/读取云存储的。

初步选用七牛云存储服务。

### 3、集群部署和负载均衡
经过以上两项的修改，就可以使用负载均衡来实现大规模集群方式架设系统。负载均衡实现的方案有很多，自己搭建也比较考验运维动手能力。所以这里建议选用阿里的[负载均衡SLB](https://www.aliyun.com/product/slb)产品。

阿里云负载均衡SLB包含两款产品类型，分别为应用型负载均衡ALB和传统型负载均衡CLB：
- 应用型负载均衡ALB：聚焦HTTP、HTTPS和QUIC应用层协议，面向应用交付。具备超高性能、超大弹性、丰富7层转发特性、集成WAF/云原生等能力。
- 传统型负载均衡CLB：支持TCP/UDP/HTTP/HTTPS等协议，主要面向网络交付。提供性能保障实例、高安全、高可靠、即开即用、全场景IPv6等能力。

**我们系统是应用型负载，故选择应用型负载均衡ALB。**
#### 应用型负载均衡ALB-产品价格详情
ALB目前仅支持按量付费。ALB费用由三部分组成：实例费、性能容量单位LCU（Loadbalancer Capacity Unit）费和公网网络费。[具体参考链接](https://www.aliyun.com/price/product?spm=5176.7921785.J_5253785160.6.70a62229XnQsUE#/slb/detail/slb)


