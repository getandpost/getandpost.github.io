# 苹果应用接口地址修改问题

## 问题描述
我们开发一款苹果手机App,接口地址以前是用api.xxx.com的。后来换了接口地址apinew.xxx.com了。然后苹果项目工程里面都搜不到api.xxx.com了。但服务器日志还是有访问api.xxx.com的记录，奇怪的是有请求访问新接口地址，有请求访问老接口地址。不知何原因。

## 原因分析
### 1. NSAppTransportSecurity 配置（最常见）
检查 Info.plist 文件中的网络安全配置：
```xml
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSExceptionDomains</key>
    <dict>
        <key>api.xxx.com</key>  <!-- ❌ 这里可能还是旧域名 -->
        <dict>
            <key>NSIncludesSubdomains</key>
            <true/>
            <key>NSTemporaryExceptionAllowsInsecureHTTPLoads</key>
            <true/>
        </dict>
    </dict>
</dict>
```

解决方法：
- 将 api.xxx.com 改为 apinew.xxx.com
- 或者删除旧域名配置

### 2. 配置文件（plist/json/config）
检查项目中的配置文件：

```bash
# 在项目根目录搜索
find . -name "*.plist" -o -name "*.json" -o -name "*.config" | xargs grep "api.xxx.com"
```

### 3. Build Configuration / Scheme
检查 Xcode 的构建配置：

步骤：

1. Xcode → Product → Scheme → Edit Scheme
2. 检查 Run/Archive 的 Build Configuration
3. 查看是否有环境变量配置

可能的位置：

- xcconfig 文件
- Build Settings → User-Defined
- Preprocessor Macros


```bash
# 搜索 xcconfig 文件
find . -name "*.xcconfig" | xargs grep "api.xxx.com"
```

### 4. Embedded Framework / SDK
如果使用了第三方SDK或自己的Framework：

```bash
# 搜索 .framework 和 .a 文件
find . -name "*.framework" -o -name "*.a"

# 检查是否有硬编码的旧域名
strings YourFramework.framework/YourFramework | grep "api.xxx.com"
```
解决方法：

- 重新编译Framework
- 更新第三方SDK版本


### 5. 缓存的 Build Products
Xcode可能使用了缓存的旧版本：

清理步骤：
```bash
# 1. Clean Build Folder
Xcode → Product → Clean Build Folder (Shift + Cmd + K)

# 2. 删除 DerivedData
rm -rf ~/Library/Developer/Xcode/DerivedData/*

# 3. 删除项目缓存
cd YourProject
rm -rf build/
rm -rf Pods/  # 如果用 CocoaPods

# 4. 重新安装依赖
pod install  # 或 pod update
```

### 6. CocoaPods / Carthage / SPM 依赖
检查依赖库的配置：

```bash
# CocoaPods
cat Podfile | grep "api.xxx.com"
pod update

# Carthage
cat Cartfile | grep "api.xxx.com"
carthage update --platform iOS

# Swift Package Manager
# 检查 Package.swift 或 Xcode → File → Swift Packages
```

### 7. Archive 时的配置
检查 Archive 构建配置：

步骤：

1. Xcode → Product → Scheme → Edit Scheme
2. 选择 Archive
3. 查看 Build Configuration（通常是 Release）
4. 检查 Release 配置是否有特殊设置

```bash
# 检查 Release 配置
grep -r "api.xxx.com" *.xcodeproj/
```

### 8. Assets / Resource Bundle
检查资源文件：

```bash
# 搜索所有资源文件
find . -name "*.strings" -o -name "*.plist" -o -name "*.json" | xargs grep "api.xxx.com"

# 检查 Assets.xcassets
find . -name "*.xcassets" -exec grep -r "api.xxx.com" {} \;
```

## 完整排查步骤
### 第一步：全局搜索（包括隐藏文件）
```bash
cd /path/to/your/project

# 搜索所有文件（包括二进制）
grep -r "api.xxx.com" . 2>/dev/null

# 只搜索文本文件
find . -type f \( -name "*.m" -o -name "*.swift" -o -name "*.plist" -o -name "*.json" -o -name "*.xcconfig" \) -exec grep -l "api.xxx.com" {} \;

# 搜索二进制文件
find . -type f \( -name "*.framework" -o -name "*.a" \) -exec strings {} \; | grep "api.xxx.com"
```

### 第二步：检查 Info.plist
```bash
# 查看编译后的 Info.plist
cd ~/Library/Developer/Xcode/DerivedData/YourApp-*/Build/Products/Release-iphoneos/YourApp.app/
cat Info.plist | grep "api.xxx.com"
```

### 第三步：检查 Archive
```bash
# 查看最近的 Archive
cd ~/Library/Developer/Xcode/Archives/

# 找到最新的 .xcarchive
ls -lt

# 检查 Archive 中的配置
cd YourApp.xcarchive/Products/Applications/YourApp.app/
cat Info.plist | grep "api.xxx.com"
strings YourApp | grep "api.xxx.com"
```
### 第四步：清理并重新构建
```bash
# 1. 清理所有缓存
rm -rf ~/Library/Developer/Xcode/DerivedData/*
rm -rf build/

# 2. 如果用 CocoaPods
pod deintegrate
pod install

# 3. 重新打开项目
open YourProject.xcworkspace

# 4. Clean Build Folder (Shift + Cmd + K)
# 5. Archive (Product → Archive)
```

## 快速检查脚本
创建一个脚本快速检查：

```bash
#!/bin/bash
# check_old_api.sh

echo "🔍 检查旧API域名: api.xxx.com"
echo "================================"

echo "\n📁 检查源代码文件..."
find . -type f \( -name "*.m" -o -name "*.swift" -o -name "*.h" \) -exec grep -l "api.xxx.com" {} \;

echo "\n📋 检查配置文件..."
find . -type f \( -name "*.plist" -o -name "*.json" -o -name "*.xcconfig" \) -exec grep -l "api.xxx.com" {} \;

echo "\n📦 检查Framework..."
find . -type f \( -name "*.framework" -o -name "*.a" \) -exec sh -c 'echo "检查: $1"; strings "$1" | grep "api.xxx.com"' _ {} \;

echo "\n🔨 检查 DerivedData..."
grep -r "api.xxx.com" ~/Library/Developer/Xcode/DerivedData/ 2>/dev/null | head -5

echo "\n✅ 检查完成"
```

使用方法：
1. 保存脚本为 `check_old_api.sh`
2. 给脚本添加执行权限：`chmod +x check_old_api.sh`
3. 运行脚本：`./check_old_api.sh`


## 总结
1. 根据经验，90%的情况是以下两个原因之一：
2. Info.plist 中的 NSAppTransportSecurity 配置
DerivedData 缓存没清理干净
建议先检查这两个，然后清理重新构建。